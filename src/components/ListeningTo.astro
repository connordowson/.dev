---
import Section from "@components/Section.astro";

const client_id = import.meta.env.SPOTIFY_CLIENT_ID;
const client_secret = import.meta.env.SPOTIFY_CLIENT_SECRET;
const refresh_token = import.meta.env.SPOTIFY_REFRESH_TOKEN;

const tokenEndpoint = "https://accounts.spotify.com/api/token";
const topTracksEndpoint =
  "https://api.spotify.com/v1/me/top/tracks?time_range=short_term&limit=6";
const spotifySecrets = Buffer.from(`${client_id}:${client_secret}`).toString(
  "base64"
);

const getAccessToken = async () => {
  const response = await fetch(tokenEndpoint, {
    method: "POST",
    headers: {
      Authorization: `Basic ${spotifySecrets}`,
      "Content-Type": "application/x-www-form-urlencoded",
    },
    body: new URLSearchParams({ grant_type: "refresh_token", refresh_token }),
  });

  return response.json();
};

const getTopTracks = async () => {
  const { access_token } = await getAccessToken();

  return await fetch(topTracksEndpoint, {
    headers: {
      Authorization: `Bearer ${access_token}`,
    },
  });
};

const response = await getTopTracks();

const { items } = await response.json();

const topTracks = items.map((track) => ({
  name: track.name,
  artist: track.artists.map((artist) => artist.name).join(", "),
  artwork: track.album.images[2].url,
}));
---

<Section class="max-w-7xl" relative>
  <h2 class="dark:text-emerald-400 mb-4 text-emerald-500">
    What I've been listening to
  </h2>
  <p class="mb-4 dark:text-slate-100 text-slate-900">
    My top played songs from the Spotify API (so I can't hide any embarrassing
    ones).
  </p>
  <div
    class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 dark:border-white/10 dark:backdrop-blur-[2px]"
  >
    {
      topTracks.map(({ name, artist, artwork }) => (
        <div class="dark:bg-white/5  p-2 rounded-lg flex items-center w-full gap-2 shadow-sm border dark:border-white/5 bg-white/20 border-slate-800/10">
          <img
            src={artwork}
            alt={`Album artwork for ${name}`}
            class="rounded-md self-start shrink-0"
          />

          <div class="ml-1 min-w-0">
            <span class="block font-bold font-display dark:text-slate-100 text-slate-800">
              {name}
            </span>
            <span class="text-ellipsis w-full whitespace-nowrap overflow-hidden block dark:text-slate-200 text-slate-700">
              {artist}
            </span>
          </div>
        </div>
      ))
    }
  </div>
  <!-- <svg
    xmlns="http://www.w3.org/2000/svg"
    xml:space="preserve"
    id="Layer_1"
    x="0"
    y="0"
    style="enable-background:new 0 0 334.2 204.8;"
    version="1.1"
    viewBox="0 0 334.2 204.8"
    ><path
      d="M314.9 24.8 166.7 3.2 148.2.5l-20.2 35-54.6 94.6c-4.1-3.2-9.6-5.5-16.4-6.4-20.5-3-44.3 7.1-53.2 22.6s.4 30.4 20.9 33.3c20.5 3 44.3-7.1 53.2-22.6l68.6-118.8 148.2 21.6-54.6 94.6c-3.8-3.1-9.6-5.5-16.4-6.4-20.5-3-44.3 7.1-53.2 22.6s.4 30.4 20.9 33.3c20.5 3 44.3-7.1 53.2-22.6l68.6-118.8 20.2-34.9-18.5-2.8z"
      stroke-width="0.1"
      class="stroke-emerald-400 fill-none"></path>
  </svg> -->

  <svg
    version="1.1"
    id="Layer_1"
    xmlns="http://www.w3.org/2000/svg"
    xmlns:xlink="http://www.w3.org/1999/xlink"
    x="0px"
    y="0px"
    viewBox="0 0 412.4 267.8"
    style="enable-background:new 0 0 412.4 267.8;"
    xml:space="preserve"
    stroke-width="0.1"
    class="fill-none"
  >
    <path
      class="stroke-emerald-400/20"
      d="M228.9,267.3c-4.4,0-8.3-0.5-11.7-1c-20.8-3-37.2-14.1-45.1-30.5c-7.2-14.9-6.3-32.3,2.6-47.7
	c13.2-22.8,42-38.1,71.8-38.1c3.4,0,6.8,0.2,10,0.6l20.2-34.9l-84.3-12.3L134,204.6c-13.2,22.8-42,38.1-71.8,38.1
	c-3.9,0-7.9-0.3-11.7-0.8c-20.8-3-37.2-14.1-45.1-30.4C-1.9,196.3-1,179.4,8,163.8c13.2-22.8,42-38.1,71.8-38.1
	c3.4,0,6.8,0.2,10,0.6L162.5,0.5l249.1,36.2L300.7,229C287.7,251.5,258.2,267.3,228.9,267.3L228.9,267.3z"
    ></path>
    <path
      class="stroke-emerald-400/30"
      d="M228.9,257.3c-3.7,0-7.2-0.5-10.2-0.9c-17.4-2.5-31.1-11.6-37.6-24.9c-5.8-11.9-5-25.9,2.2-38.3
	c11.4-19.8,36.8-33.1,63.2-33.1c3.5,0,7,0.2,10.2,0.7c1.7,0.2,3.4,0.6,5,0.9l31-53.7L187.2,92.5l-61.8,107.1
	c-11.4,19.8-36.8,33.1-63.2,33.1c-3.5,0-6.9-0.2-10.2-0.7c-17.5-2.5-31.2-11.6-37.6-24.9c-5.8-12.1-5.1-25.7,2.2-38.3
	c11.4-19.8,36.8-33.1,63.2-33.1c3.5,0,6.9,0.2,10.2,0.7c1.7,0.2,3.4,0.6,5,0.9l72.7-126l227.8,33.1L292.1,224
	C280.7,243.6,254.8,257.3,228.9,257.3L228.9,257.3z"
    ></path>
    <path
      class="stroke-emerald-400/40"
      d="M228.9,247.3c-3,0-5.9-0.4-8.8-0.8c-14.1-2.1-25.1-9.2-30-19.4c-4.4-9-3.7-19.3,1.9-29
	c9.5-16.5,32-28.1,54.5-28.1c3,0,5.9,0.2,8.8,0.6c4,0.6,7.7,1.5,11.1,2.9l42.4-73.4L181.9,81.7l-65.2,112.9
	c-9.5,16.5-32,28.1-54.5,28.1c-3,0-5.9-0.2-8.8-0.6c-14.1-2.1-25.1-9.1-30-19.3c-4.4-9-3.7-19.3,1.9-28.9
	c9.5-16.5,32-28.1,54.5-28.1c3,0,5.9,0.2,8.8,0.6c4,0.6,7.7,1.6,11.1,2.9l73.3-127l206.5,30L283.4,219
	C273.8,235.6,251.4,247.3,228.9,247.3C228.9,247.3,228.9,247.3,228.9,247.3z"
    ></path>
    <path
      class="stroke-emerald-400/50"
      d="M345,57.4L196.8,35.9l-18.5-2.7l-20.2,34.9l-54.6,94.6c-4.1-3.2-9.6-5.5-16.4-6.4c-20.5-3-44.3,7.1-53.2,22.6
	s0.4,30.4,20.9,33.3c20.5,3,44.3-7.1,53.2-22.6l68.6-118.8l148.2,21.6l-54.6,94.6c-3.8-3.1-9.6-5.5-16.4-6.4
	c-20.5-3-44.3,7.1-53.2,22.6s0.4,30.4,20.9,33.3c20.5,3,44.3-7.1,53.2-22.6L343.3,95l20.2-34.9L345,57.4z"
    ></path>
  </svg>
</Section>

<style lang="scss">
  svg {
    position: absolute;
    height: 140%;
    right: -300px;
    top: 50%;
    transform: translateY(-50%);
    z-index: -1;
  }
</style>
