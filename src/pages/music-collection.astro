---
import BaseLayout from "@layouts/Base.astro";
import Section from "@components/Section.astro";

// Lazy way to remove extra details returned by Discogs API
// Like for artists with the same name as another artist, it returns "Artist (2)"
// And for albums with a deluxe edition, it returns "Album (Deluxe Edition)"
const sanitize_artist_name = (artist) => {
  return artist.replace(" (2)", "");
};

const sanitize_album_title = (album) => {
  return album
    .replace(" (The Platinum Pleasure Edition)", "")
    .replace(" = Etazhi", "");
};

const discogs_api_key = import.meta.env.DISCOGS_API_TOKEN;

const discogsCollectionData = await fetch(
  `https://api.discogs.com/users/dows/collection/folders/0/releases?token=${discogs_api_key}&per_page=25&sort=added&sort_order=desc`
).then((res) => res.json());

const discogsCollection = discogsCollectionData.releases.map((release) => {
  return {
    id: release.id,
    title: sanitize_album_title(release.basic_information.title),
    artist: sanitize_artist_name(release.basic_information.artists[0].name),
    year: release.basic_information.year,
    cover_image: release.basic_information.cover_image,
    genres: release.basic_information.genres,
  };
});

console.log(discogsCollectionData.releases[0]);
---

<BaseLayout title="Music collection | Connor Dowson">
  <Section fixed>
    <h1>Music collection</h1>

    <div class="prose flow">
      <p>
        My collection of music owned on vinyl. Sourced from my <a
          href="https://www.discogs.com/user/dows/collection?header=1"
          >Discogs account</a
        >.
      </p>
      <div class="grid music-grid">
        {
          discogsCollection?.map((release) => {
            return (
              <div class="flow">
                <img src={release.cover_image} alt={release.title} />
                <h3>{release.title}</h3>

                <p>{release.artist}</p>
              </div>
            );
          })
        }
      </div>
    </div>
  </Section>
</BaseLayout>
